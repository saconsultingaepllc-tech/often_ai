name: Bank Vault Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────
  # Fast tests: unit + integration (no emulator)
  # Runs functions and openai-proxy in parallel
  # ─────────────────────────────────────────────
  unit-and-integration:
    name: "Unit & Integration (${{ matrix.package }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [functions, openai-proxy]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: ${{ matrix.package }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ matrix.package }}

      - name: Run unit tests
        run: npm run test:unit
        working-directory: ${{ matrix.package }}

      - name: Run integration tests
        run: npm run test:integration
        working-directory: ${{ matrix.package }}

  # ─────────────────────────────────────────────
  # Emulator tests: security rules + full E2E
  # Spins up Firestore, Auth, and Functions emulators
  # ─────────────────────────────────────────────
  emulator-tests:
    name: Security Rules & E2E
    runs-on: ubuntu-latest
    env:
      FIRESTORE_EMULATOR_HOST: 127.0.0.1:8080
      FIREBASE_AUTH_EMULATOR_HOST: 127.0.0.1:9099
      FIREBASE_WEB_API_KEY: test-ci-key
      ADMIN_API_KEY: test-ci-admin-key
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: functions/package-lock.json

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install functions dependencies
        run: npm ci
        working-directory: functions

      - name: Start emulators
        run: |
          # Create .env so the functions emulator can load env vars
          printf 'FIREBASE_WEB_API_KEY=test-ci-key\nADMIN_API_KEY=test-ci-admin-key\n' > functions/.env
          cat functions/.env

          firebase emulators:start --only auth,firestore,functions \
            --project ext-hub &

          # Wait for Firestore emulator
          for i in $(seq 1 30); do
            if curl -s http://127.0.0.1:8080/ > /dev/null 2>&1; then
              echo "Firestore emulator ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Firestore emulator failed to start"
              exit 1
            fi
            echo "Waiting for Firestore emulator... ($i/30)"
            sleep 2
          done

          # Wait for Functions emulator
          for i in $(seq 1 30); do
            if curl -s http://127.0.0.1:5001/ > /dev/null 2>&1; then
              echo "Functions emulator ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Functions emulator failed to start"
              exit 1
            fi
            echo "Waiting for Functions emulator... ($i/30)"
            sleep 2
          done

      - name: Run security rules tests
        run: npm run test:rules
        working-directory: functions

      - name: Run E2E tests
        working-directory: functions
        run: npx jest --testMatch='**/e2e.test.js' --rootDir=.. --forceExit --detectOpenHandles
        env:
          FUNCTIONS_BASE: http://127.0.0.1:5001/ext-hub/us-central1
          TEST_ADMIN_KEY: test-ci-admin-key

  # ─────────────────────────────────────────────
  # Lint
  # ─────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: functions/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: functions

      - name: ESLint
        run: npm run lint
        working-directory: functions

  # ─────────────────────────────────────────────
  # Gate: all jobs must pass before merging
  # ─────────────────────────────────────────────
  gate:
    name: All Tests Pass
    runs-on: ubuntu-latest
    if: always()
    needs: [unit-and-integration, emulator-tests, lint]
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.unit-and-integration.result }}" != "success" ] || \
             [ "${{ needs.emulator-tests.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ]; then
            echo "One or more required jobs failed:"
            echo "  unit-and-integration: ${{ needs.unit-and-integration.result }}"
            echo "  emulator-tests: ${{ needs.emulator-tests.result }}"
            echo "  lint: ${{ needs.lint.result }}"
            exit 1
          fi
          echo "All checks passed."
